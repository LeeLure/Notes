## 表单保存时

### 业务逻辑

- 表单保存时需要设置各个数据库的 借阅时间 和 预计归还时间，并找出该图书的第一个可借的书籍id，修改其借阅状态，再根据关联信息设置各个数据库的关联项。

### 开始

- 进入逻辑控制并点击新增。

### 提交数据—提交数据以获取返回的主键(data_id)

- 拖入 提交数据 并连接 开始。

### 组件动作—获取节约时间和预计归还时间

- 拖入 组件动作 后添加两个组件：
—组件选择 借阅时间，动作选择 取值，返回值输入 借阅时间，格式选择 日期；
—组件选择 预计归还时间，动作选择 取值，返回值输入 预计归还时间，格式选择 日期；

### 服务编排—借阅逻辑

- 业务逻辑

	- 根据 data_id 去 借阅表匹配对应的数据项并输出其 parent_id， 根据 parent_id 去匹配 图书表 和 书籍表 的对应项并输出，确定要借出的书是哪一个库存书籍，获取其数据后修改其状态，并修改关联表的数据。

- 开始

	- 拖入 服务编排；
—传入参数输入 data_id、值 选择 表单数据主键；
—传入参数输入 借阅时间、值 选择 库存数量；
—传入参数输入 预计归还时间、值 选择 预计归还时间；

- 变量计算—定义后续需要用到的变量

	-  

- 数据读取—根据 data_id 拿到借阅表的匹配项并输出

	-  

- 变量计算—通过表达式拿到 借阅记录 的parent_id

	-  

- 数据读取—根据上一步的 parent_id 匹配图书管理表的图书并输出 可借数量

	-  

- 变量计算—通过表达式将 可借数量-1

	-  

- 数据读取—根据上方的 parent_id 匹配书籍(库存)表的所有书籍并输出 借阅状态 

	-  

- 循环判定—遍历上一步输出的数组

	- 循环配置

		-  

	- 判定为是

		- 变量计算—通过表达式拿到当前项的 借阅状态 和 data_id

			-  

		- 分支判定—判定当前书籍状态是否为可借状态

			- 判定条件

				-  

			- 判定为是

				- 进行下一步。

			- 判定为否

				- 继续循环。

	- 特殊说明

		- 循环没有否的逻辑是因为目前从 书城 加入 我的书架 时会将 我的书架 的这条记录的 是否已借出 改为 0(表示目前这本书可借)，判断这本书能否借阅的条件是只要库存还有可借数量的就可借，哪怕当前用户已经借了一本且未归还的情况下还是可以新借一本一模一样的。

- 数据操作—修改要借出的书籍的数据

	-  

- 数据操作—修改图书管理表的可借数量

	-  

- 数据操作—修改当前借阅记录的数据

	-  

- 数据操作—修改我的书架中对应的数据

	-  

### 通知提示—提示用户操作成功

### 模块回调—返回列表页并刷新列表

### 结束—无需输出字段

