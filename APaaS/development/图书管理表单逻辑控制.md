# 图书管理表单逻辑控制

## 表单保存时

### 业务逻辑

- 表单保存时需要设置入库时间、根据库存数量及表单项生成库存信息、计算并设置可借数量。

### 开始

- 进入逻辑控制并点击新增。

### 提交数据—提交数据以获取返回的主键(data_id)

- 拖入 提交数据 并连接 开始；

### 操作变量—定义借阅状态

- 拖入 操作变量 选择 定义变量并输入变量名称为 借阅状态 获取方式选择 自定义、类型为 字符串 、输入 值 为 已入库。

### 服务编排—设置入库时间

- 业务逻辑

	- 定义入库时间、根据传入的 data_id 匹配 图书管理表 的 data_id 、给匹配项的 入库时间 赋值。

- 开始

	- 拖入 服务编排 传入参数输入 data_id、值 选择 表单数据主键

- 定义入库时间

	- 拖入 变量计算 选择 新增变量 、输入变量名 入库时间 、选择获取值方式为 系统变量 、值选择 当前时间。

- 找到图书管理表的匹配项进行赋值

	- 拖入 数据操作 ，数据资产 选择 图书管理表单的资产、类型为 更新、配置条件为 data_id 等于 data_id、输入字段只添加 入库时间、值 为上方定义的 入库时间，返回 变量名称 输入 res 即可，暂时用不到。

- 结束

	- 拖入 结束 并连接，返回值 入库时间 输入逻辑控制变量名 入库时间 。

### 组件动作—获取表单项的数据

- —拖入 组件动作 后添加三个组件：
—组件选择 入库时间 、动作选择 设值 、变量选择 入库时间；
—组件选择 库存数量 、动作选择 取值 、返回值 输入 库存数量 并选择 值 ；
—组件选择 书名 、动作选择取值 、返回值输入 书名 并选择 值 ；
—组件选择 分类 、动作选择 取值 、返回值输入 分类 并选择 值。

### 服务编排—操作库存数据

- 业务逻辑

	- 需要根据用户输入的库存数量循环生成库存数据，且批量操作时需要判断是新增还是删除，增加 是否已借出 的字段，该字段在 我的书架列表 用以判断当前书籍状态，不用 借阅状态 是因为状态可能变更为 逾期未归还 。

- 开始

	- 拖入 服务编排；
—传入参数输入 data_id、值 选择 表单数据主键；
—传入参数输入 库存数量、值 选择 库存数量；
—传入参数输入 借阅状态、值 选择 借阅状态；
—传入参数输入 书名、值选择 书名；
—传入参数输入分类、值 选择 分类。

- 变量定义-定义是否已借出

	- 拖入变量计算、选择 新增变量 、输入变量名 是否已借出、获取值方式选择 固定值 、值选择 数值 、输入 数字 0；

- 数据读取-读取书籍表并返回数组

	- 拖入数据读取、数据资产选择 书籍表 、配置条件为 parent_id 等于 data_id、输出字段添加 data_id、parent_id、输出变量为新增变量、自定义变量名为 current_sj_arr。

- 分支判定-判定书籍表的返回是否为空

	- 业务逻辑

		- 判断当前操作时新增还是编辑，新增就批量插入，编辑就批量修改字段。

	- 判定条件

		- 拖入 分支判定、条件设置为 全部满足、新增条件、变量选择上一步返回的 current_sj_arr、比较方式选择 为空。

	- 判定为是

		- 业务逻辑

			- 书籍表返回的数组为空说明是新增，新增需要循环用户输入的 库存数量 生成对应条数的数据，并将传入的表单字段赋值给每条数据。

		- 循环判定

			- 业务逻辑

				- 循环 库存数量 次，每次循环时向 书籍表 插入一条数据，每次循环结束时将 库存数量 减 1。

			- 判定条件

				- 拖入 循环判定、模式选择 判定、index 名称 输入 i、默认初始值为 0、游标计算的表达式为 ${库存数量}-1 (点击进入表达式配置，在变量栏双击 库存数量、在编辑区域输入 -1、点击确定)、循环条件直接在编辑区域输入 i>=0 。

			- 判定为是

				- 业务逻辑

					- 有匹配项才执行下列操作，没有匹配项直接结束。

				- ID生成器—生成每条数据(书籍)的对应ID

					- 拖入 id生成器、结果输出选择 新增变量、变量名输入 id、模式选择 自定义、规则配置为 序号、6位。

				- 数据操作-向 书籍表 插入数据

					- 拖入 数据操作、资产选择 图书管理表、操作类型为新增、添加六个输入字段分别为：书名、分类、是否已借出、借阅状态、data_id、parent_id，分别对应传入以及定义变量的值、结果默认新增变量，输入 res 即可。

				- 变量操作—循环结束时将 库存数量 -1

					- 拖入变量操作、变量计算方式选择 表达式。表达式配置为 ${库存数量}-1、结果输出选择已有变量—库存数量；并将下一步的流程拖回到 循环判定以形成闭环。

			- 判定为否

				- 结束

	- 判定为否

		- 业务逻辑

			- 书籍表返回的数组不为空说明是编辑，循环匹配到的数组中的每一项，拿到每一项的 data_id 去书籍表匹配对应的数据，修改其字段。

		- 循环遍历

			- 业务逻辑

				- 循环匹配到的数组，每次循环时修改 书籍表 对应的数据，每次循环结束时将 库存数量 -1。

			- 判定条件

				- 拖入循环判定、模式选择遍历、变量选择 书籍表返回的数组(current_sj_arr)，循环游标输入 i，循环变量名(所循环的每一项，相当于 item)输入 current_sj_obj，类型选择 对象。

			- 判定为是

				- 业务逻辑

					- 有匹配项才执行下列操作，没有匹配项直接结束。

				- 变量计算-获取当前项的 data_id

					- 拖入 变量计算、计算变量的方式选择 表达式、表达式配置为 current_sj_obj.data_id、结果输出选择 新增变量、变量名输入 current_sj_data_id、类型为 字符串。

				- 数据操作—修改 书籍表 的匹配项

					- 拖入 数据操作、数据资产选择 书籍表 、操作类型为 更新、条件配置为 data_id 等于 current_sj_data_id、输入字段为 分类 和 书名 并分别对应外部传进来的变量、结果输出选择 新增变量、变量名为 res1。

				- 变量操作—循环结束时将 库存数量 -1

					- 拖入变量操作、变量计算方式选择 表达式。表达式配置为 ${库存数量}-1、结果输出选择已有变量—库存数量；并将下一步的流程拖回到 循环判定以形成闭环。

			- 判定为否

				- 结束

- 结束—无需输出字段

### 服务编排—计算并设置可借数量

- 业务逻辑

	- —可借数量是根据书籍的借阅状态判定并统计的，新增时可以直接用 库存数量 赋值，但编辑时书籍的借阅状态可能不确定，故此需要判断和计算；
—定义 可借状态 和 可借数量(默认为0)，读取 书籍表 匹配的的所有书籍并输出，循环该数组，根据其每一项和 可借状态 进行匹配，匹配成功则 可借数量 +1，匹配失败则进行下一次循环。

- 开始

	- 拖入 服务编排，传入参数输入 data_id、值 选择 表单数据主键；

- 变量计算—定义可借状态和可借数量

	- 拖入 变量计算、配置三个变量，分别为：
已入库：选择 新增变量 、输入变量名 已入库、获取值方式选择 固定值 、值选择 字符串 、输入 已入库；
已归还：选择 新增变量 、输入变量名 已归还、获取值方式选择 固定值 、值选择 字符串 、输入 已归还；
可借数量：选择 新增变量 、输入变量名 可借数量、获取值方式选择 固定值 、值选择 数值 、输入 数字 0；

- 数据读取—读取并输出对应的所有书籍

	- 拖入 数据读取、资产选择 书籍表、配置条件为 parent_id 等于 data_id、输出字段只有一个 借阅状态、输出变量为 新增变量、变量名称为 current_sj_arr；

- 循环判定—循环遍历数组的每一项

	- 业务逻辑

		- 循环上一步输出的数组，在内部进行判定，匹配成功则 可借数量+1，匹配失败则 进行下次循环；

	- 判定条件

		- 拖入循环判定、模式选择遍历、变量选择上一步返回的数组(current_sj_arr)，循环游标输入 i，循环变量名(所循环的每一项，相当于 item)输入 current_sj_obj，类型选择 对象。

	- 判定为是

		- 变量计算—输出每一项的借阅状态

			- 拖入 变量计算、计算方式选择 表达式、表达式配置为 current_sj_obj.jieyuezhuangtai、输出选择新增变量、变量名称输入 借阅状态、类型为 字符串；

		- 分支判定—判定当前项是否为可借状态

			- 业务逻辑

				- 判定当前项的 借阅状态 是否是 可借状态，为是就给变量 可借数量 +1，为否就继续循环；

			- 判定条件

				- 拖入 分支判定、条件设置为 部分满足、增加两个条件分别为：
—变量选择 借阅状态、比较方式选择 等于、比较目标选择 变量、变量选择 已入库；
—变量选择 借阅状态、比较方式选择 等于、比较目标选择 变量、变量选择 已归还；

			- 判定为是

				- 变量计算—计算可借数量

					- 拖入 变量计算、计算方式选择表达式、表达式设置为 ${可借数量}+1、结果输出选择 已有变量 并选择 可借数量；

			- 判定为否

				- 继续循环

	- 判定为否

		- 跳出循环并进行下一步。

- 数据操作—设置图书管理表匹配项的可借数量

	- 拖入 数据操作、资产选择 图书管理表、操作类型选择 更新、条件配置为 data_id 等于 data_id、输入字段添加 可借数量 并设置值为 可借数量、结果输出选择 新增变量 并输入 res；

- 结束

### 通知提示—提示用户操作成功

- 拖入 通知提示、类型选择 成功提示。内容类型选择 字符串 并输入 操作成功；

### 模块回调—返回到列表页并刷新页面

- 拖入 模块回调 上下连接即可；

### 结束—业务逻辑结束

## 编辑表单加载完成

### 业务逻辑

- 不允许用户编辑 库存数量，故编辑表单加载完成时需要禁用 库存数量。

### 开始

- 进入逻辑控制并点击新增。

### 组件动作—禁用库存数量

- 拖入组件动作、组件选择 库存数量、动作选择 禁用。

### 结束

- 业务逻辑结束。

